<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IoT Control Temperatura</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>

<style>
.glow-on { box-shadow: 0 0 20px #fbbf24; border-color: #fbbf24; }
.glass-panel {
    background: rgba(30,41,59,0.7);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
}
</style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen font-sans">

<div class="max-w-4xl mx-auto p-4">

    <header class="flex justify-between items-center py-6">
        <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300">
            Control de Temperatura IoT
        </h1>
        <button onclick="openConfig()" type="button" class="p-2 rounded-full bg-slate-800 hover:bg-slate-700 border border-slate-600">
            <i data-lucide="settings" class="w-5 h-5 text-slate-300"></i>
        </button>
    </header>

    <div id="statusIndicator" class="mb-6 flex items-center gap-3 bg-red-500/10 border border-red-500/20 p-3 rounded-lg">
        <span class="relative flex h-3 w-3">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
        </span>
        <span class="text-sm font-medium text-red-400">Desconectado de Firebase</span>
    </div>

    <!-- Modo -->
    <div class="glass-panel p-6 rounded-2xl mb-6 flex justify-between items-center">
        <div>
            <h2 class="text-xl font-semibold">Modo</h2>
            <span class="text-sm text-slate-400">Automático / Manual</span>
        </div>
        <button type="button" onclick="changeMode()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-xl">
            Cambiar Modo
        </button>
        <span id="modeStatus" class="ml-4 font-bold">AUTO</span>
    </div>

    <!-- Cargas -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">

        <div class="glass-panel p-6 rounded-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Ventilador</h2>
                <span id="ventStatus" class="font-bold">OFF</span>
            </div>
            <button type="button" onclick="toggleManual('vent')" class="bg-blue-500 hover:bg-blue-400 text-white font-bold py-2 px-4 rounded-xl w-full">
                Encender / Apagar
            </button>
        </div>

        <div class="glass-panel p-6 rounded-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Calefactor</h2>
                <span id="calefStatus" class="font-bold">OFF</span>
            </div>
            <button type="button" onclick="toggleManual('calef')" class="bg-red-500 hover:bg-red-400 text-white font-bold py-2 px-4 rounded-xl w-full">
                Encender / Apagar
            </button>
        </div>

    </div>

    <!-- Temperaturas -->
    <div class="glass-panel p-6 rounded-2xl mb-6">
        <h2 class="text-xl font-semibold mb-4">Sensores de Temperatura</h2>
        <canvas id="tempChart" height="150"></canvas>
    </div>

</div>

<!-- Modal Configuración Firebase -->
<div id="configModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
    <div class="bg-slate-900 border border-slate-700 p-6 rounded-2xl w-11/12 max-w-md shadow-2xl">
        <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
            Configuración Firebase
        </h3>
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">API KEY</label>
                <input type="text" id="apiKeyInput" placeholder="AIzaSy..." class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-sm text-white">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Database URL</label>
                <input type="text" id="dbUrlInput" placeholder="https://proyecto.firebaseio.com" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-sm text-white">
            </div>
        </div>
        <div class="mt-6 flex gap-3">
            <button type="button" onclick="closeConfig()" class="flex-1 py-3 text-slate-400 hover:text-white">Cancelar</button>
            <button type="button" onclick="saveConfig()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl">Guardar y Conectar</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

let app, db, tempChart, tempData = { labels: [], datasets: [] };

// UI Helpers
window.openConfig = () => document.getElementById('configModal').classList.remove('hidden');
window.closeConfig = () => document.getElementById('configModal').classList.add('hidden');

window.saveConfig = () => {
    const apiKey = document.getElementById('apiKeyInput').value.trim();
    const dbUrl = document.getElementById('dbUrlInput').value.trim();
    if(!apiKey||!dbUrl) return Swal.fire('Error','Faltan datos','error');
    localStorage.setItem('iot_api_key',apiKey);
    localStorage.setItem('iot_db_url',dbUrl);
    initFirebase(apiKey,dbUrl);
    closeConfig();
};

function initFirebase(apiKey,databaseURL){
    try{
        const firebaseConfig = { apiKey, databaseURL };
        app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        updateStatusUI(true);

        // Lecturas sensores
        const sensRef = ref(db,'/sensores');
        onValue(sensRef,(snapshot)=>{
            const data = snapshot.val();
            if(!data) return;
            updateChart(data);
        },(err)=>updateStatusUI(false));

        // Lectura cargas y modo
        const cargasRef = ref(db,'/cargas');
        onValue(cargasRef,(snapshot)=>{
            const data = snapshot.val();
            if(!data) return;
            document.getElementById('ventStatus').innerText = data.vent?'ON':'OFF';
            document.getElementById('calefStatus').innerText = data.calef?'ON':'OFF';
            document.getElementById('modeStatus').innerText = (data.mode||'auto').toUpperCase();
        });

    }catch(e){
        console.error(e);
        Swal.fire('Error','Credenciales inválidas','error');
        updateStatusUI(false);
    }
}

// Cambiar Modo con contraseña
function changeMode(){
    if(!db) return Swal.fire('Error','Firebase no configurado','error');
    Swal.fire({
        title:'Ingresa contraseña',
        input:'password',
        inputPlaceholder:'Contraseña',
        showCancelButton:true,
        preConfirm: (pass) => {
            if(pass!=='2005') Swal.showValidationMessage('Contraseña incorrecta');
            else return true;
        }
    }).then(res=>{
        if(res.isConfirmed){
            const currentMode = document.getElementById('modeStatus').innerText.toLowerCase();
            const newMode = (currentMode==='auto')?'manual':'auto';
            set(ref(db,'/cargas/mode'),newMode)
            .then(()=>document.getElementById('modeStatus').innerText=newMode.toUpperCase())
            .catch(err=>Swal.fire('Error',err.message,'error'));
        }
    });
}

// Control manual de cargas con contraseña
function toggleManual(carga){
    if(!db) return Swal.fire('Error','Firebase no configurado','error');
    Swal.fire({
        title:'Ingresa contraseña',
        input:'password',
        inputPlaceholder:'Contraseña',
        showCancelButton:true,
        preConfirm: (pass) => {
            if(pass!=='2005') Swal.showValidationMessage('Contraseña incorrecta');
            else return true;
        }
    }).then(res=>{
        if(res.isConfirmed){
            const el = document.getElementById(carga==='vent'?'ventStatus':'calefStatus');
            const current = el.innerText==='ON';
            set(ref(db,'/cargas/'+carga),!current)
            .then(()=>el.innerText=!current?'ON':'OFF')
            .catch(err=>Swal.fire('Error',err.message,'error'));
        }
    });
}

// Chart.js setup
function updateChart(data){
    const labels = ['T1','T2','T3','T4','Promedio'];
    const temps = [
        data.t1||0,
        data.t2||0,
        data.t3||0,
        data.t4||0,
        data.promedio||0
    ];

    if(!tempChart){
        const ctx = document.getElementById('tempChart').getContext('2d');
        tempChart = new Chart(ctx,{
            type:'bar',
            data:{
                labels: labels,
                datasets:[{
                    label:'Temperatura °C',
                    data: temps,
                    backgroundColor:['#f59e0b','#f97316','#ea580c','#dc2626','#3b82f6']
                }]
            },
            options:{
                responsive:true,
                plugins:{legend:{display:false}},
                scales:{y:{beginAtZero:true}}
            }
        });
    }else{
        tempChart.data.datasets[0].data=temps;
        tempChart.update();
    }
}

// Estado conexión
function updateStatusUI(connected){
    const el = document.getElementById('statusIndicator');
    if(connected){
        el.className="mb-6 flex items-center gap-3 bg-emerald-500/10 border border-emerald-500/20 p-3 rounded-lg";
        el.innerHTML=`<span class="relative flex h-3 w-3">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
        </span><span class="text-sm font-medium text-emerald-400">Conectado a Firebase</span>`;
    }else{
        el.className="mb-6 flex items-center gap-3 bg-red-500/10 border border-red-500/20 p-3 rounded-lg";
        el.innerHTML=`<span class="h-3 w-3 rounded-full bg-red-500"></span><span class="text-sm font-medium text-red-400">Desconectado</span>`;
    }
}

// Cargar config guardada
const savedKey = localStorage.getItem('iot_api_key');
const savedUrl = localStorage.getItem('iot_db_url');
if(savedKey && savedUrl){
    document.getElementById('apiKeyInput').value=savedKey;
    document.getElementById('dbUrlInput').value=savedUrl;
    initFirebase(savedKey,savedUrl);
}else{
    setTimeout(openConfig,500);
}

lucide.createIcons();
</script>
</body>
</html>
